<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SCADA Admin Panel</title>
    <link rel="stylesheet" href="/styles/admin.css?v=20260237" />
  </head>
  <body class="admin-app">
    <div class="layout">
      <aside class="sidebar">
        <div class="brand">
          <div class="brand-title">SCADA</div>
          <div class="brand-sub">Admin Panel</div>
        </div>

          <nav class="nav">
          <a href="#users" data-view="users" class="nav-link">Users</a>
          <a href="#roles" data-view="roles" class="nav-link">Roles</a>
          <a href="#plc" data-view="plc" class="nav-link">PLC Builder</a>
          <a href="#instruments" data-view="instruments" class="nav-link">Instruments</a>
          <a href="#meta" data-view="meta" class="nav-link">Datapoint Meta</a>
          <a href="#access" data-view="access" class="nav-link">Access Control</a>
          <a href="#alarms" data-view="alarms" class="nav-link">Manage Alarms</a>
          <a href="#alarm-log" data-view="alarm-log" class="nav-link">Alarm Log</a>
          <a href="#command-log" data-view="command-log" class="nav-link">Command Log</a>
        </nav>
      </aside>

      <div class="main">
        <header class="topbar">
          <div class="who">
            <span class="muted">Signed in as</span>
            <strong id="me-name">...</strong>
          </div>
          <div class="top-actions">
            <button id="logout-btn" class="btn">Logout</button>
          </div>
        </header>

        <main class="content">
          <!-- USERS -->
          <section id="view-users" class="view">
            <div class="view-header">
              <h2>Users</h2>
              <div class="actions">
                <button id="btn-user-new" class="btn primary">New User</button>
                <button id="btn-users-refresh" class="btn">Refresh</button>
              </div>
            </div>

            <div class="toolbar">
              <input id="users-search" class="input" placeholder="Search username…" />
              <select id="users-filter-active" class="input">
                <option value="all">All</option>
                <option value="inactive">Inactive</option>
              </select>
            </div>

            <div id="users-status" class="status"></div>
            <div class="table-wrap">
              <table class="table" id="users-table">
                <thead>
                  <tr>
                    <th style="width: 70px">ID</th>
                    <th>Username</th>
                    <th style="width: 80px">Active</th>
                    <th>Roles</th>
                    <th style="width: 320px">Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </section>

          <!-- ROLES -->
          <section id="view-roles" class="view hidden">
            <div class="view-header">
              <h2>Roles</h2>
              <div class="actions">
                <button id="btn-role-new" class="btn primary">New Role</button>
                <button id="btn-roles-refresh" class="btn">Refresh</button>
              </div>
            </div>

            <div class="toolbar">
              <input id="roles-search" class="input" placeholder="Search roles…" />
            </div>

            <div id="roles-status" class="status"></div>
            <div class="split">
              <div>
                <div class="table-wrap">
                  <table class="table" id="roles-table">
                    <thead>
                      <tr>
                        <th style="width: 70px">ID</th>
                        <th>Name</th>
                        <th>Description</th>
                        <th style="width: 140px">Perms</th>
                        <th style="width: 220px">Actions</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>

              <div class="panel">
                <h3>Role Permissions</h3>
                <p class="muted">Select a role to edit its permissions.</p>

                <div id="role-editor" class="hidden">
                  <div class="row">
                    <strong id="role-editor-name"></strong>
                    <div class="actions">
                      <button id="btn-role-access" class="btn">Manage Access</button>
                      <button id="btn-role-delete" class="btn danger">Delete Role</button>
                    </div>
                  </div>

                  <div class="row">
                    <input id="perm-input" class="input" placeholder="e.g., config:read" />
                    <button id="btn-perm-add" class="btn">Add Permission</button>
                  </div>

                  <ul id="perm-list" class="chips"></ul>
                </div>
              </div>
            </div>
          </section>

          <!-- PLC BUILDER -->
          <section id="view-plc" class="view hidden">
            <div class="view-header">
              <h2>PLC Builder</h2>
              <div class="actions">
                <button id="btn-plc-refresh" class="btn">Refresh</button>
                <button id="btn-plc-add" class="btn primary">Add PLC</button>
              </div>
            </div>

            <div id="plc-status" class="status"></div>

            <div class="split">
              <div class="panel">
                <div class="row">
                  <h3>Tree</h3>
                  <input id="cfg-search" class="input" placeholder="Filter tree…" />
                </div>
                <div id="cfg-tree" class="tree"></div>
              </div>

              <div class="panel">
                <div class="row">
                  <h3>Details</h3>
                  <div class="actions">
                    <button id="btn-node-save" class="btn">Save</button>
                    <button id="btn-node-delete" class="btn danger">Delete</button>
                  </div>
                </div>
                <div id="node-status" class="status"></div>
                <div id="node-editor" class="muted">Select a node from the tree.</div>
              </div>
            </div>
          </section>

          <!-- INSTRUMENTS -->
          <section id="view-instruments" class="view hidden">
            <div class="view-header">
              <h2>Instrument Registry</h2>
              <div class="actions">
                <button id="btn-instruments-refresh" class="btn">Refresh</button>
                <button id="btn-instruments-bulk-map" class="btn">Bulk Map</button>
                <button id="btn-instruments-add" class="btn primary">Add Instrument</button>
              </div>
            </div>

            <div class="toolbar">
              <input id="instrument-search" class="input" placeholder="Search code / serial / datapoint label" />
              <select id="instrument-filter-equipment" class="input">
                <option value="">All Equipment</option>
              </select>
              <select id="instrument-filter-type" class="input">
                <option value="">All Types</option>
              </select>
              <select id="instrument-filter-status" class="input">
                <option value="">All Status</option>
                <option value="active">Active</option>
                <option value="oos">OOS</option>
                <option value="retired">Retired</option>
              </select>
              <select id="instrument-filter-calibration" class="input">
                <option value="">Calibration Due (All)</option>
                <option value="overdue">Overdue</option>
                <option value="7d">Next 7d</option>
                <option value="30d">Next 30d</option>
              </select>
            </div>

            <div id="instruments-status" class="status"></div>

            <div class="table-wrap">
              <table class="table" id="instruments-table">
                <thead>
                  <tr>
                    <th style="width: 130px">Instrument Code</th>
                    <th>Name</th>
                    <th>Equipment</th>
                    <th style="width: 140px">Type</th>
                    <th style="width: 200px">PV Datapoint</th>
                    <th style="width: 120px">Health Score</th>
                    <th style="width: 150px">Calibration Due</th>
                    <th style="width: 130px">Spares Status</th>
                    <th style="width: 110px">Status</th>
                    <th class="actions-col" style="width: 220px">Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div class="row" style="margin-top: 12px">
              <div class="muted" id="instruments-pagination">Showing 0 of 0</div>
              <div class="actions">
                <button class="btn small" id="btn-instruments-prev">Prev</button>
                <button class="btn small" id="btn-instruments-next">Next</button>
              </div>
            </div>

            <dialog id="modal-bulk-map" class="modal" style="max-width: 1200px; width: 90%;">
              <div class="modal-body">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                  <h3>Bulk Map - Instruments with No Mappings</h3>
                  <button type="button" class="btn small" onclick="this.closest('dialog').close()">Close</button>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 16px; max-height: 600px;">
                  <!-- LEFT: Instruments list -->
                  <div style="border: 1px solid var(--border); border-radius: 4px; display: flex; flex-direction: column;">
                    <div style="padding: 12px; border-bottom: 1px solid var(--border); font-weight: bold;">Instruments to Map</div>
                    <div id="bulk-map-instruments-list" style="flex: 1; overflow-y: auto;"></div>
                  </div>
                  <!-- RIGHT: Datapoints for selected instrument -->
                  <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div style="border: 1px solid var(--border); border-radius: 4px; padding: 12px; background-color: var(--panel);">
                      <div id="bulk-map-selected-instrument" class="muted">No instrument selected</div>
                    </div>
                    <div style="border: 1px solid var(--border); border-radius: 4px; display: flex; flex-direction: column;">
                      <div style="padding: 12px; border-bottom: 1px solid var(--border); font-weight: bold;">Available Datapoints</div>
                      <input id="bulk-map-dp-search" type="text" placeholder="Search datapoints..." style="margin: 8px; padding: 8px; border: 1px solid var(--border); border-radius: 4px;" />
                      <div id="bulk-map-datapoints-list" style="flex: 1; overflow-y: auto; padding: 0 8px;"></div>
                    </div>
                  </div>
                </div>
                <div id="bulk-map-status" class="status" style="margin-top: 12px;"></div>
              </div>
            </dialog>
          </section>

          <!-- DATAPOINT META -->
          <section id="view-meta" class="view hidden">
            <div class="view-header">
              <h2>Datapoint Meta</h2>
              <div class="actions">
                <button id="btn-meta-refresh" class="btn">Refresh</button>
              </div>
            </div>

            <div class="split">
              <div class="panel">
                <div class="row">
                  <h3>Classes</h3>
                  <div class="actions">
                    <button id="btn-dpclass-new" class="btn primary">New</button>
                    <button id="btn-dpclass-refresh" class="btn">Refresh</button>
                  </div>
                </div>
                <div id="dpclass-status" class="status"></div>
                <div class="table-wrap">
                  <table class="table" id="dpclass-table">
                    <thead>
                      <tr>
                        <th style="width: 70px">ID</th>
                        <th>Name</th>
                        <th>Description</th>
                        <th style="width: 220px">Actions</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>

              <div class="panel">
                <div class="row">
                  <h3>Units</h3>
                  <div class="actions">
                    <button id="btn-dpunit-new" class="btn primary">New</button>
                    <button id="btn-dpunit-refresh" class="btn">Refresh</button>
                  </div>
                </div>
                <div id="dpunit-status" class="status"></div>
                <div class="table-wrap">
                  <table class="table" id="dpunit-table">
                    <thead>
                      <tr>
                        <th style="width: 70px">ID</th>
                        <th>Name</th>
                        <th>Description</th>
                        <th style="width: 220px">Actions</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="panel" style="margin-top: 16px">
              <div class="row">
                <h3>Groups</h3>
                <div class="actions">
                  <button id="btn-dpgroup-new" class="btn primary">New</button>
                  <button id="btn-dpgroup-refresh" class="btn">Refresh</button>
                </div>
              </div>
              <div id="dpgroup-status" class="status"></div>
              <div class="table-wrap">
                <table class="table" id="dpgroup-table">
                  <thead>
                    <tr>
                      <th style="width: 70px">ID</th>
                      <th>Name</th>
                      <th>Description</th>
                      <th style="width: 220px">Actions</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- ALARMS -->
          <section id="view-alarms" class="view hidden">
            <div class="view-header">
              <h2>Manage Alarms</h2>
              <div class="actions">
                <button id="btn-alarms-refresh" class="btn">Refresh</button>
                <button id="btn-alarm-rule-new" class="btn primary">Add Rule</button>
              </div>
            </div>

            <div class="split">
              <div class="panel">
                <h3>Datapoint</h3>
                <div class="field" style="margin-top: 10px">
                  <div class="label">Group</div>
                  <select id="alarms-group-select" class="input"></select>
                </div>
                <div class="field" style="margin-top: 10px">
                  <div class="label">Datapoint</div>
                  <select id="alarms-datapoint-select" class="input"></select>
                </div>
                <div id="alarms-datapoint-info" class="hint muted"></div>
              </div>

              <div class="panel">
                <div class="row">
                  <h3>Rules</h3>
                </div>
                <div class="toolbar">
                  <input id="alarms-search" class="input" placeholder="Filter rules…" />
                </div>

                <div id="alarms-status" class="status"></div>
                <div class="table-wrap">
                  <table class="table" id="alarms-table">
                    <thead>
                      <tr>
                        <th>Name</th>
                        <th style="width: 90px">Severity</th>
                        <th style="width: 130px">Comparison</th>
                        <th style="width: 160px">Warning</th>
                        <th style="width: 160px">Alarm</th>
                        <th>Schedule</th>
                        <th style="width: 90px">Enabled</th>
                        <th style="width: 220px">Actions</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>

          <!-- ALARM LOG -->
          <section id="view-alarm-log" class="view hidden">
            <div class="view-header">
              <h2>Alarm Log</h2>
              <div class="actions">
                <button id="btn-alarm-log-refresh" class="btn">Refresh</button>
              </div>
            </div>

            <div class="toolbar">
              <input id="alarm-log-search" class="input" placeholder="Filter message or source…" />
              <select id="alarm-log-severity" class="input">
                <option value="">All severities</option>
                <option value="critical">critical</option>
                <option value="major">major</option>
                <option value="minor">minor</option>
                <option value="info">info</option>
              </select>
              <label style="margin-left:8px"><input id="alarm-log-acked" type="checkbox" /> Show only acked</label>
            </div>

            <div id="alarm-log-status" class="status"></div>
            <div class="table-wrap">
              <table class="table" id="alarm-log-table">
                <thead>
                  <tr>
                    <th>Time</th>
                    <th>Severity</th>
                    <th>Message</th>
                    <th>Source</th>
                    <th>Acked</th>
                    <th style="width:160px">Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </section>

          <!-- COMMAND LOG -->
          <section id="view-command-log" class="view hidden">
            <div class="view-header">
              <h2>Command Log</h2>
              <div class="actions">
                <button id="btn-command-log-refresh" class="btn">Refresh</button>
              </div>
            </div>

            <div id="command-log-status" class="status"></div>
            <div class="table-wrap">
              <table class="table" id="command-log-table">
                <thead>
                  <tr>
                    <th>Time</th>
                    <th>PLC</th>
                    <th>Container</th>
                    <th>Equipment</th>
                    <th>Data Point</th>
                    <th>Bit Label</th>
                    <th>Value</th>
                    <th>Status</th>
                    <th>Attempts</th>
                    <th>User</th>
                    <th>Client IP</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </section>

          <!-- ACCESS CONTROL -->
          <section id="view-access" class="view hidden">
            <div class="view-header">
              <h2>Access Control</h2>
              <div class="actions">
                <button id="btn-access-refresh" class="btn">Refresh</button>
                <button id="btn-grants-clear" class="btn danger">Clear Grants</button>
              </div>
            </div>

            <div class="toolbar">
              <label class="field">
                <span class="label">Principal Type</span>
                <select id="principal-type" class="input">
                  <option value="role">Role</option>
                  <option value="user">User</option>
                </select>
              </label>

              <label class="field">
                <span class="label">Principal</span>
                <select id="principal-id" class="input"></select>
              </label>

              <input id="principal-search" class="input" placeholder="Search principal…" />
              <input id="access-search" class="input" placeholder="Filter tree…" />
            </div>

            <div id="access-status" class="status"></div>

            <div class="split">
              <div class="panel">
                <h3>PLC Tree Grants</h3>
                <p class="muted">
                  Toggles set <strong>explicit</strong> grants. Effective access may also be inherited from ancestors with include_descendants enabled.
                </p>
                <div id="access-tree" class="tree"></div>
              </div>

              <div class="panel">
                <h3>Explicit Grants</h3>
                <div id="grants-list" class="list muted">Select a principal to load grants.</div>

                <div class="hr"></div>

                <h3>Access Preview</h3>
                <div id="access-preview" class="muted">Select a node to see effective access.</div>
              </div>
            </div>
          </section>

        </main>
      </div>
    </div>

    <!-- Modals -->
    <dialog id="modal-user" class="modal">
      <form method="dialog" class="modal-body" id="form-user">
        <h3 id="modal-user-title">User</h3>
        <input type="hidden" name="id" />

        <label>
          Username
          <input name="username" autocomplete="username" required />
        </label>

        <label>
          Password (min 12 chars)
          <input name="password" type="password" minlength="12" autocomplete="new-password" />
          <div class="hint muted">Leave blank when editing to keep the current password.</div>
        </label>

        <label class="row">
          <span>Active</span>
          <input name="is_active" type="checkbox" checked />
        </label>

        <label>
          Roles
          <select name="roles" id="user-roles" multiple size="6" class="input"></select>
          <div id="user-roles-help" class="hint muted"></div>
        </label>

        <div class="row right">
          <button class="btn" value="cancel">Cancel</button>
          <button class="btn primary" id="btn-user-save" value="default">Save</button>
        </div>

        <div id="modal-user-status" class="status"></div>
      </form>
    </dialog>

    <dialog id="modal-reset-password" class="modal">
      <form method="dialog" class="modal-body" id="form-reset-password">
        <h3>Reset Password</h3>
        <input type="hidden" name="id" />
        <div class="hint muted" id="reset-user-label"></div>
        <label>
          New password (min 12 chars)
          <input name="password" type="password" minlength="12" autocomplete="new-password" required />
        </label>
        <div class="row right">
          <button class="btn" value="cancel">Cancel</button>
          <button class="btn primary" id="btn-reset-password" value="default">Update</button>
        </div>
        <div id="modal-reset-status" class="status"></div>
      </form>
    </dialog>

    <dialog id="modal-role" class="modal">
      <form method="dialog" class="modal-body" id="form-role">
        <h3 id="modal-role-title">Role</h3>
        <input type="hidden" name="id" />
        <label>
          Name
          <input name="name" required />
        </label>
        <label>
          Description
          <input name="description" placeholder="Optional" />
        </label>
        <div class="row right">
          <button class="btn" value="cancel">Cancel</button>
          <button class="btn primary" id="btn-role-save" value="default">Save</button>
        </div>
        <div id="modal-role-status" class="status"></div>
      </form>
    </dialog>

    <dialog id="modal-plc" class="modal">
      <form method="dialog" class="modal-body" id="form-plc">
        <h3>New PLC</h3>
        <label>
          Name
          <input name="name" required />
        </label>
        <label>
          IP
          <input name="ip" placeholder="192.168.0.10" required />
        </label>
        <label>
          Port
          <input name="port" type="number" min="1" max="65535" value="502" required />
        </label>
        <div class="row right">
          <button class="btn" value="cancel">Cancel</button>
          <button class="btn primary" id="btn-plc-create" value="default">Create</button>
        </div>
        <div id="modal-plc-status" class="status"></div>
      </form>
    </dialog>

    <dialog id="modal-link-instrument" class="modal">
      <form method="dialog" class="modal-body" id="form-link-instrument">
        <h3>Link Instrument</h3>

        <label>
          Datapoint
          <input id="dp-link-datapoint-label" class="input" readonly value="" />
        </label>

        <div class="muted" id="dp-link-current">Not linked</div>

        <label>
          Search
          <div class="row" style="gap: 8px">
            <input id="dp-link-search" class="input" placeholder="Search code / name / serial / type" />
            <button class="btn" id="btn-dp-link-search" type="button">Search</button>
          </div>
        </label>

        <label>
          Instrument
          <select id="dp-link-instrument" class="input" required>
            <option value="">Select instrument</option>
          </select>
        </label>

        <div class="row right">
          <button class="btn" value="cancel">Cancel</button>
          <button class="btn primary" id="btn-dp-link-save" value="default">Save Link</button>
        </div>

        <div id="modal-link-instrument-status" class="status"></div>
      </form>
    </dialog>

    <dialog id="modal-instrument" class="modal">
      <form method="dialog" class="modal-body" id="form-instrument">
        <h3>Add Instrument</h3>

        <div class="hr"></div>
        <div class="muted">Identity</div>
        <div class="split" style="grid-template-columns: 1fr 1fr">
          <label>
            Instrument Code
            <input name="instrument_code" required />
          </label>
          <label>
            Name
            <input name="name" />
          </label>
          <label>
            Type
            <select name="type" class="input">
              <option value="">Select type</option>
              <option value="pressure">Pressure</option>
              <option value="temperature">Temperature</option>
              <option value="flow">Flow</option>
              <option value="level">Level</option>
              <option value="vibration">Vibration</option>
              <option value="other">Other</option>
            </select>
          </label>
          <label>
            Make
            <input name="make" />
          </label>
          <label>
            Model
            <input name="model" />
          </label>
          <label>
            Serial No
            <input name="serial" />
          </label>
          <label>
            Firmware
            <input name="firmware" />
          </label>
        </div>

        <div class="hr"></div>
        <div class="muted">Location</div>
        <div class="split" style="grid-template-columns: 1fr 1fr">
          <label>
            Equipment
            <select id="instrument-equipment" name="equipment_id" class="input">
              <option value="">Select equipment</option>
            </select>
          </label>
          <label>
            Location
            <input name="location" />
          </label>
          <label>
            Criticality
            <select name="criticality" class="input">
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
            </select>
          </label>
          <label>
            Status
            <select name="status" class="input">
              <option value="active" selected>Active</option>
              <option value="oos">OOS</option>
              <option value="retired">Retired</option>
            </select>
          </label>
        </div>

        <div class="hr"></div>
        <div class="muted">Dates</div>
        <div class="split" style="grid-template-columns: 1fr 1fr">
          <label>
            Install Date
            <input name="install_date" type="date" />
          </label>
          <label>
            Commission Date
            <input name="commission_date" type="date" />
          </label>
          <label>
            Warranty Expiry
            <input name="warranty_expiry" type="date" />
          </label>
        </div>

        <div class="row right">
          <button class="btn" value="cancel">Cancel</button>
          <button class="btn primary" id="btn-instrument-save" value="default">Save</button>
        </div>

        <div id="modal-instrument-status" class="status"></div>
      </form>
    </dialog>

    <dialog id="modal-instrument-detail" class="modal">
      <div class="modal-body">
        <h3 id="instrument-detail-title">Instrument Detail</h3>

        <div class="row" style="gap: 8px; flex-wrap: wrap; margin-bottom: 10px">
          <button type="button" class="btn small primary" data-tab="overview">Overview</button>
          <button type="button" class="btn small" data-tab="mapping">Datapoint Mapping</button>
          <button type="button" class="btn small" data-tab="health">Health</button>
          <button type="button" class="btn small" data-tab="calibration">Calibration</button>
          <button type="button" class="btn small" data-tab="spares">Spares</button>
          <button type="button" class="btn small" data-tab="workorders">Work Orders</button>
        </div>

        <div id="instrument-detail-tab-overview">
          <div class="split" style="grid-template-columns: 1fr 1fr">
            <label>
              Instrument Code
              <input id="instrument-detail-code" readonly />
            </label>
            <label>
              Name
              <input id="instrument-detail-name" readonly />
            </label>
            <label>
              Type
              <input id="instrument-detail-type" readonly />
            </label>
            <label>
              Model
              <input id="instrument-detail-model" readonly />
            </label>
            <label>
              Serial No
              <input id="instrument-detail-serial" readonly />
            </label>
            <label>
              Status
              <input id="instrument-detail-status" readonly />
            </label>
            <label>
              Equipment
              <input id="instrument-detail-equipment" readonly />
            </label>
            <label>
              Location
              <input id="instrument-detail-location" readonly />
            </label>
            <label>
              Criticality
              <input id="instrument-detail-criticality" readonly />
            </label>
            <label>
              Datapoint Mapping
              <input id="instrument-detail-mapping" readonly />
            </label>
          </div>
        </div>

        <div id="instrument-detail-tab-mapping" class="hidden">
          <div class="muted" style="margin-bottom: 8px">Current Mappings</div>
          <div class="table-wrap" style="margin-bottom: 12px">
            <table class="table" id="instrument-detail-mapping-table">
              <thead>
                <tr>
                  <th style="width: 110px">Role</th>
                  <th style="width: 140px">cfg_data_point_id</th>
                  <th>Label</th>
                  <th style="width: 130px">Address</th>
                  <th style="width: 180px">Owner</th>
                  <th style="width: 120px">Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="hr"></div>
          <div class="muted">Add Mapping</div>
          <div class="split" style="grid-template-columns: 1fr 1fr; margin-top: 8px">
            <label>
              Equipment
              <select id="instrument-detail-map-equipment" class="input">
                <option value="">Select equipment</option>
              </select>
            </label>
            <label>
              Search
              <input id="instrument-detail-map-search" class="input" placeholder="Filter by label / address / type" />
            </label>
            <label>
              Results
              <select id="instrument-detail-map-dp" class="input">
                <option value="">Select datapoint</option>
              </select>
            </label>
            <label>
              Role
              <select id="instrument-detail-map-role" class="input">
                <option value="process" selected>process</option>
                <option value="pv">pv</option>
                <option value="raw">raw</option>
                <option value="status">status</option>
                <option value="diag">diag</option>
              </select>
            </label>
          </div>

          <div class="row right" style="margin-top: 8px">
            <button type="button" class="btn primary" id="btn-instrument-detail-add-mapping">Add Mapping</button>
          </div>
          <div id="instrument-detail-mapping-status" class="status"></div>
        </div>
        <div id="instrument-detail-tab-health" class="hidden">
          <div class="row" style="justify-content: space-between; align-items: center">
            <div class="muted">Instrument Health</div>
            <button type="button" class="btn small" id="btn-instrument-detail-health-refresh">Refresh Health</button>
          </div>

          <div class="split" style="grid-template-columns: 1fr 1fr">
            <label>
              Score
              <div id="instrument-detail-health-score" class="row" style="min-height: 34px; align-items: center"></div>
            </label>
            <label>
              last_sample_ts
              <input id="instrument-detail-health-last-sample-ts" readonly />
            </label>
            <label>
              sample_count
              <input id="instrument-detail-health-sample-count" readonly />
            </label>
            <label>
              Flags
              <div id="instrument-detail-health-flags" class="muted">-</div>
            </label>
          </div>

          <div class="muted">simple_stats</div>
          <div class="split" style="grid-template-columns: 1fr 1fr">
            <label>
              min
              <input id="instrument-detail-health-stat-min" readonly />
            </label>
            <label>
              max
              <input id="instrument-detail-health-stat-max" readonly />
            </label>
            <label>
              avg
              <input id="instrument-detail-health-stat-avg" readonly />
            </label>
            <label>
              std
              <input id="instrument-detail-health-stat-std" readonly />
            </label>
          </div>

          <details>
            <summary class="muted">Advanced query</summary>
            <div class="split" style="grid-template-columns: 1fr 1fr; margin-top: 8px">
              <label>
                window_minutes
                <input id="instrument-detail-health-window-minutes" type="number" min="1" step="1" value="10" />
              </label>
              <label>
                flatline_minutes
                <input id="instrument-detail-health-flatline-minutes" type="number" min="1" step="1" value="10" />
              </label>
              <label>
                max_gap_seconds
                <input id="instrument-detail-health-max-gap-seconds" type="number" min="1" step="1" value="30" />
              </label>
              <label>
                noise_std_threshold
                <input id="instrument-detail-health-noise-std-threshold" type="number" min="0" step="any" placeholder="optional" />
              </label>
            </div>
          </details>

          <div id="instrument-detail-health-status" class="status"></div>
        </div>
        <div id="instrument-detail-tab-calibration" class="hidden">
          <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 16px;">
            <div id="calibration-status-banner"></div>
            <button type="button" class="btn small" id="btn-calibration-add">+ Add</button>
          </div>
          <div class="scrollable-table" style="max-height: 400px; overflow-y: auto;">
            <table class="compact">
              <thead>
                <tr>
                  <th>Date/Time</th>
                  <th>Method</th>
                  <th>Result</th>
                  <th>As Found</th>
                  <th>As Left</th>
                  <th>Performed By</th>
                  <th>Certificate #</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody id="calibration-table-body"></tbody>
            </table>
          </div>
          <div id="calibration-status" class="status" style="margin-top: 12px;"></div>
        </div>
        <div id="instrument-detail-tab-spares" class="hidden">
          <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 16px;">
            <button type="button" class="btn small" id="btn-spares-add">+ Add Spare</button>
          </div>
          <div class="scrollable-table" style="max-height: 400px; overflow-y: auto;">
            <table class="compact">
              <thead>
                <tr>
                  <th>Part Code</th>
                  <th>Name</th>
                  <th>Qty per Replacement</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="spares-table-body"></tbody>
            </table>
          </div>
          <div id="spares-status" class="status" style="margin-top: 12px;"></div>
        </div>
        <div id="instrument-detail-tab-workorders" class="hidden">
          <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 16px;">
            <button type="button" class="btn small" id="btn-workorder-add">+ Create Work Order</button>
          </div>
          <div class="scrollable-table" style="max-height: 400px; overflow-y: auto;">
            <table class="compact">
              <thead>
                <tr>
                  <th>Code</th>
                  <th>Title</th>
                  <th>Status</th>
                  <th>Priority</th>
                  <th>Created</th>
                  <th>Due</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="workorders-table-body"></tbody>
            </table>
          </div>
          <div id="workorders-status" class="status" style="margin-top: 12px;"></div>
        </div>

        <div class="row right" style="margin-top: 12px">
          <button type="button" class="btn" id="btn-instrument-detail-close">Close</button>
        </div>
      </div>
    </dialog>

    <dialog id="modal-add-calibration" class="modal">
      <form method="dialog" class="modal-body" id="form-add-calibration">
        <h3>Add Calibration</h3>
        <div class="split" style="grid-template-columns: 1fr 1fr">
          <div class="field">
            <label>Calibration Date/Time
              <input id="calibration-ts" type="datetime-local" required />
            </label>
          </div>
          <div class="field">
            <label>Next Due Date
              <input id="calibration-next-due-at" type="date" />
            </label>
          </div>
        </div>
        <div class="split" style="grid-template-columns: 1fr 1fr">
          <div class="field">
            <label>Method
              <input id="calibration-method" type="text" placeholder="e.g., PT100 calibrator, multimeter" />
            </label>
          </div>
          <div class="field">
            <label>Result
              <select id="calibration-result">
                <option value="">-- Select --</option>
                <option value="pass">Pass</option>
                <option value="fail">Fail</option>
                <option value="conditional">Conditional</option>
              </select>
            </label>
          </div>
        </div>
        <div class="split" style="grid-template-columns: 1fr 1fr">
          <div class="field">
            <label>As Found
              <input id="calibration-as-found" type="text" placeholder="e.g., +0.5% error" />
            </label>
          </div>
          <div class="field">
            <label>As Left
              <input id="calibration-as-left" type="text" placeholder="e.g., +0.1% error" />
            </label>
          </div>
        </div>
        <div class="split" style="grid-template-columns: 1fr 1fr">
          <div class="field">
            <label>Performed By
              <input id="calibration-performed-by" type="text" placeholder="e.g., John Smith" />
            </label>
          </div>
          <div class="field">
            <label>Certificate #
              <input id="calibration-certificate-no" type="text" placeholder="e.g., CAL-2024-001" />
            </label>
          </div>
        </div>
        <div class="field">
          <label>Notes
            <textarea id="calibration-notes" placeholder="Additional notes..."></textarea>
          </label>
        </div>
        <div class="hr"></div>
        <div class="row right">
          <button type="button" class="btn" onclick="this.closest('dialog').close()">Cancel</button>
          <button type="submit" class="btn primary">Save</button>
        </div>
      </form>
    </dialog>

    <dialog id="modal-add-spare" class="modal">
      <form method="dialog" class="modal-body" id="form-add-spare">
        <h3>Add Spare Part</h3>
        <div class="field">
          <label>Search Spare Parts
            <input id="spare-search" type="text" placeholder="Search by code or name..." />
          </label>
        </div>
        <div id="spare-search-results" style="border: 1px solid var(--border); border-radius: 4px; max-height: 200px; overflow-y: auto; margin-bottom: 12px;">
          <div id="spare-search-results-empty" class="muted" style="padding: 12px;">No spare parts found</div>
        </div>
        <div class="field">
          <label>Selected Spare Part
            <input id="spare-selected" type="text" placeholder="Select a spare part" readonly />
            <input id="spare-selected-id" type="hidden" />
          </label>
        </div>
        <div class="field">
          <label>Qty per Replacement
            <input id="spare-qty-per-replacement" type="number" min="1" step="1" value="1" />
          </label>
        </div>
        <div class="hr"></div>
        <div class="row right">
          <button type="button" class="btn" onclick="this.closest('dialog').close()">Cancel</button>
          <button type="submit" class="btn primary">Add</button>
        </div>
      </form>
    </dialog>

    <dialog id="modal-create-workorder" class="modal">
      <form method="dialog" class="modal-body" id="form-create-workorder">
        <h3>Create Work Order</h3>
        <div class="split" style="grid-template-columns: 1fr 1fr">
          <div class="field">
            <label>Title
              <input id="workorder-title" type="text" placeholder="Brief description" required />
            </label>
          </div>
          <div class="field">
            <label>Priority
              <select id="workorder-priority" required>
                <option value="">-- Select --</option>
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
                <option value="urgent">Urgent</option>
              </select>
            </label>
          </div>
        </div>
        <div class="field">
          <label>Description
            <textarea id="workorder-description" placeholder="Full details..."></textarea>
          </label>
        </div>
        <div class="split" style="grid-template-columns: 1fr 1fr">
          <div class="field">
            <label>Due Date (optional)
              <input id="workorder-due-at" type="date" />
            </label>
          </div>
          <div class="field">
            <label>Assigned User ID (optional)
              <input id="workorder-assigned-user-id" type="number" placeholder="e.g., 123" />
            </label>
          </div>
        </div>
        <div class="hr"></div>
        <div class="row right">
          <button type="button" class="btn" onclick="this.closest('dialog').close()">Cancel</button>
          <button type="submit" class="btn primary">Create</button>
        </div>
      </form>
    </dialog>

    <dialog id="modal-add-child" class="modal">
      <form method="dialog" class="modal-body" id="form-add-child">
        <h3 id="child-title">Add</h3>
        <input type="hidden" name="id" />
        <input type="hidden" name="parent_type" />
        <input type="hidden" name="parent_id" />
        <input type="hidden" name="child_type" />

        <div id="child-fields"></div>

        <div class="row right">
          <button class="btn" value="cancel">Cancel</button>
          <button class="btn primary" id="btn-child-create" value="default">Save</button>
        </div>

        <div id="modal-child-status" class="status"></div>
      </form>
    </dialog>

    <dialog id="modal-meta-option" class="modal">
      <form method="dialog" class="modal-body" id="form-meta-option">
        <h3 id="modal-meta-title">Option</h3>
        <input type="hidden" name="kind" />
        <input type="hidden" name="id" />

        <label>
          Name
          <input name="name" required />
        </label>

        <label>
          Description
          <input name="description" />
        </label>

        <div class="row right">
          <button class="btn" value="cancel">Cancel</button>
          <button class="btn primary" id="btn-meta-save" value="default">Save</button>
        </div>

        <div id="modal-meta-status" class="status"></div>
      </form>
    </dialog>

    <dialog id="modal-alarm-rule" class="modal">
      <form id="form-alarm-rule" class="modal-body" method="dialog">
        <h3 id="alarm-rule-modal-title">Alarm Rule</h3>
        <div id="alarm-rule-status" class="status"></div>

        <div class="field">
          <div class="label">Datapoint</div>
          <select id="alarm-rule-datapoint" class="input"></select>
        </div>

        <div class="field">
          <div class="label">Name</div>
          <input id="alarm-rule-name" class="input" placeholder="e.g., High temperature" />
        </div>

        <div class="row">
          <label class="inline"><input id="alarm-rule-enabled" type="checkbox" checked /> Enabled</label>
          <label class="inline"><input id="alarm-rule-warning-enabled" type="checkbox" /> Warning</label>
          <label class="inline"><input id="alarm-rule-schedule-enabled" type="checkbox" /> Scheduled</label>
        </div>

        <div class="split" style="grid-template-columns: 1fr 1fr">
          <div class="field">
            <div class="label">Severity</div>
            <select id="alarm-rule-severity" class="input">
              <option value="critical">critical</option>
              <option value="major">major</option>
              <option value="minor">minor</option>
              <option value="info" selected>info</option>
            </select>
          </div>
          <div class="field">
            <div class="label">Comparison</div>
            <select id="alarm-rule-comparison" class="input">
              <option value="above" selected>above</option>
              <option value="below">below</option>
              <option value="outside_range">outside_range</option>
              <option value="inside_range">inside_range</option>
            </select>
          </div>
        </div>

        <div id="alarm-rule-thresholds-one" class="split" style="grid-template-columns: 1fr 1fr">
          <div class="field">
            <div class="label">Warning threshold</div>
            <input id="alarm-rule-warning-threshold" class="input" type="number" step="any" placeholder="e.g., 75" />
          </div>
          <div class="field">
            <div class="label">Alarm threshold</div>
            <input id="alarm-rule-alarm-threshold" class="input" type="number" step="any" placeholder="e.g., 80" />
          </div>
        </div>

        <div id="alarm-rule-thresholds-range" class="hidden">
          <div class="split" style="grid-template-columns: 1fr 1fr">
            <div class="field">
              <div class="label">Warning low</div>
              <input id="alarm-rule-warning-low" class="input" type="number" step="any" placeholder="e.g., 10" />
            </div>
            <div class="field">
              <div class="label">Warning high</div>
              <input id="alarm-rule-warning-high" class="input" type="number" step="any" placeholder="e.g., 20" />
            </div>
          </div>
          <div class="split" style="grid-template-columns: 1fr 1fr">
            <div class="field">
              <div class="label">Alarm low</div>
              <input id="alarm-rule-alarm-low" class="input" type="number" step="any" placeholder="e.g., 5" />
            </div>
            <div class="field">
              <div class="label">Alarm high</div>
              <input id="alarm-rule-alarm-high" class="input" type="number" step="any" placeholder="e.g., 25" />
            </div>
          </div>
        </div>

        <div id="alarm-rule-schedule" class="hidden">
          <div class="split" style="grid-template-columns: 1fr 1fr">
            <div class="field">
              <div class="label">Start time</div>
              <input id="alarm-rule-start" class="input" type="time" />
            </div>
            <div class="field">
              <div class="label">End time</div>
              <input id="alarm-rule-end" class="input" type="time" />
            </div>
          </div>
          <div class="field">
            <div class="label">Timezone (optional)</div>
            <input id="alarm-rule-tz" class="input" placeholder="e.g., UTC" />
            <div class="hint muted">Cross-midnight windows are supported (e.g., 22:00–06:00).</div>
          </div>
        </div>

        <div class="hr"></div>
        <div class="row right">
          <button type="button" id="btn-alarm-rule-cancel" class="btn">Cancel</button>
          <button type="submit" id="btn-alarm-rule-save" class="btn primary">Save</button>
        </div>
      </form>
    </dialog>

    <div id="toast" class="toast hidden"></div>
    <script src="/scripts/admin.js?v=20260241"></script>
  </body>
</html>
